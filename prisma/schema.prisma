generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN
}

enum ReviewStatus {
  WAITING_FOR_REVIEW
  PROCESSING
  CONFIRMED
}

enum UserRole {
  ADMIN
  ANALYST
  USER
  HR
  MANAGER
  FINANCE
  EMPLOYEE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LEAVE
  HOLIDAY
  WEEKOFF
  PUBLIC_HOLIDAY
}

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String?   @default("No NAME")
  email         String    @unique(map: "user_email_idx")
  emailVerified DateTime? @db.Timestamp(6)
  image         String?
  password      String? //for Hash password we can use bcrypt 
  role          UserRole  @default(USER)
  mfaEnabled    Boolean   @default(false)
  permissions   String[]  @default([])

  employee Employee?

  sessions    Session[]
  account     Account[]
  attendances Attendance[]

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt
}

model Account {
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId]) //Combine both and creates a primary key
}

model Session {
  sessionToken String   @id
  userId       String   @db.Uuid
  expires      DateTime @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Employee {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  fullName          String
  email             String   @unique(map: "employee_email_idx")

  // allow “draft profile” creation
  nationalId        String?
  phoneNo           String?
  gender            String?
  address           Json?    @db.Json
  bankAccountNumber String?

  // defaults so creation works immediately on "View"
  hireDate          DateTime @default(now())
  currency          String   @default("GBP")
  salary            Decimal? @db.Decimal(12, 2)

  userId            String   @unique @db.Uuid
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  employmentType    EmploymentType @default(FULL_TIME)
  contractEndDate   DateTime? @db.Date
  isActive          Boolean   @default(false)

  accessPerssiions  String    @default("user")
  remoteWork        Boolean?

  departmentId String?     @db.Uuid
  department   Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id], onDelete: SetNull)

  branchId String? @db.Uuid
  branch   Branch? @relation("BranchEmployees", fields: [branchId], references: [id], onDelete: SetNull)

  managesBranch     Branch?     @relation("BranchManager")
  departmentManager Department? @relation("DepartmentManager")

  positionId String?   @db.Uuid
  position   Position? @relation(fields: [positionId], references: [id])

  shiftId String? @db.Uuid
  shift   Shift?  @relation(fields: [shiftId], references: [id])

  performanceReviews PerformanceReview[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([departmentId])
  @@index([branchId])
}


model PerformanceReview {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  employeeId String   @db.Uuid
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // store the month (recommended: first day of the month)
  month  DateTime     @db.Date
  status ReviewStatus @default(WAITING_FOR_REVIEW)

  // optional fields for later
  score Decimal? @db.Decimal(5, 2)
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, month], name: "unique_review_per_employee_month")
  @@index([month])
  @@index([employeeId])
}

model Attendance {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  userId       String   @db.Uuid
  user         User     @relation(fields:[userId], references:[id], onDelete:Cascade)

  date         DateTime @db.Date

  checkIn      DateTime?
  checkOut     DateTime?
  workingHours Decimal? @db.Decimal(6,2)

  status       AttendanceStatus

  workMode     WorkMode @default(OFFICE)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, date])
  @@index([date])
  @@index([userId])
}

enum WorkMode {
  OFFICE
  REMOTE
}


model Branch {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  branchName    String
  branchAddress String
  branchPhone   String
  empCount      Int

  branchEmail String

  employees Employee[] @relation("BranchEmployees") // Employees assigned to this branch

  branchManagerId String?   @unique @db.Uuid // Branch manager (picked from Employee)
  branchManager   Employee? @relation("BranchManager", fields: [branchManagerId], references: [id], onDelete: SetNull)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([branchName])
}

model Department {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  departmentName String
  empCount       Int
  depManagerId   String?   @unique @db.Uuid
  depManager     Employee? @relation("DepartmentManager", fields: [depManagerId], references: [id])

  employees Employee[] @relation("DepartmentEmployees")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([depManagerId])
}

model Position {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String  @unique
  description String?

  employees Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Shift {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String  @unique
  startTime   String
  endTime     String
  multiplier  Decimal @default(1.0) @db.Decimal(5, 2)
  description String?

  employees Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
